<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controlador de Estoque ‚Äî Modern</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap');
    :root{
      --bg: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      --panel: rgba(20, 18, 35, 0.85); 
      --card: rgba(28, 25, 45, 0.75);
      --accent: #d4af37; /* Gold */
      --accent-secondary: #c9a961;
      --muted: #a8a4b8; 
      --white: #fdfbf7; 
      --success: #4ade80; 
      --danger: #f87171; 
      --glass: rgba(255,255,255,0.03); 
      --glass-border: rgba(212, 175, 55, 0.15);
      --radius: 20px; 
      --radius-sm: 14px; 
      --accent-glow: rgba(212, 175, 55, 0.25); 
      --shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 1px rgba(212, 175, 55, 0.1);
      --gold-gradient: linear-gradient(135deg, #d4af37 0%, #f4e5c3 50%, #d4af37 100%);
    }
    *{box-sizing:border-box;font-family:'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}
    html,body{height:100%;margin:0;background:#0f0c29;background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased;overflow-x:hidden;position:relative}
    body::before{content:'';position:fixed;inset:0;background:url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(212,175,55,0.03)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');pointer-events:none;z-index:0}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh;gap:28px;padding:32px;position:relative;z-index:1}
    .sidebar{background: var(--panel);backdrop-filter: blur(30px);border:1px solid var(--glass-border);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow), inset 0 1px 0 rgba(212,175,55,0.1);display:flex;flex-direction:column;gap:24px;position:sticky;top:32px;height:fit-content;max-height:calc(100vh - 64px);overflow-y:auto}
    .brand{display:flex;align-items:center;gap:16px;padding-bottom:20px;border-bottom:2px solid rgba(212,175,55,0.2)}
    .logo{width:56px;height:56px;border-radius:14px;background:var(--gold-gradient);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:24px;color:#1a1625;box-shadow:0 10px 30px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.3);position:relative}
    .logo::after{content:'';position:absolute;inset:2px;border-radius:12px;border:1px solid rgba(255,255,255,0.2)}
    .app-title{font-weight:800;font-size:20px;letter-spacing:-0.5px;font-family:'Playfair Display', serif;background:var(--gold-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav button{background:transparent;border:none;color:var(--muted);padding:16px 20px;border-radius:var(--radius-sm);text-align:left;cursor:pointer;font-weight:600;font-size:15px;transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);position:relative;overflow:hidden}
    .nav button::before{content:'';position:absolute;inset:0;background:var(--gold-gradient);opacity:0;transition:opacity .3s}
    .nav button:hover{color:var(--white);transform:translateX(4px)}
    .nav button:hover::before{opacity:0.05}
    .nav button.active{background:rgba(212,175,55,0.08);color:var(--accent);box-shadow:0 4px 16px rgba(212,175,55,0.12), inset 0 1px 0 rgba(212,175,55,0.2);border:1px solid rgba(212,175,55,0.2)}
    .nav button.active::before{opacity:0.1}
    .content{padding:32px;border-radius:var(--radius);background:var(--panel);backdrop-filter:blur(30px);border:1px solid var(--glass-border);box-shadow:var(--shadow), inset 0 1px 0 rgba(212,175,55,0.08)}
    header.app-header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:32px;padding-bottom:24px;border-bottom:2px solid rgba(212,175,55,0.15)}
    .search-input{background:rgba(212,175,55,0.03);border:1px solid rgba(212,175,55,0.15);padding:14px 24px;border-radius:var(--radius-sm);color:var(--white);min-width:340px;font-size:14px;transition:all .3s;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)}
    .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(212,175,55,0.1), inset 0 2px 4px rgba(0,0,0,0.1)}
    .search-input::placeholder{color:var(--muted)}
    .btn{background:var(--gold-gradient);border:none;color:#1a1625;padding:14px 28px;border-radius:var(--radius-sm);cursor:pointer;font-weight:700;font-size:14px;transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 4px 16px rgba(212,175,55,0.3), inset 0 1px 0 rgba(255,255,255,0.3);position:relative;overflow:hidden}
    .btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg, rgba(255,255,255,0.2), transparent);opacity:0;transition:opacity .3s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(212,175,55,0.4), inset 0 1px 0 rgba(255,255,255,0.3)}
    .btn:hover::before{opacity:1}
    .btn:active{transform:translateY(0)}
    .btn.ghost{background:transparent;color:var(--accent);border:1.5px solid rgba(212,175,55,0.3);box-shadow:none}
    .btn.ghost:hover{background:rgba(212,175,55,0.08);border-color:var(--accent);transform:translateY(-2px)}
    .card{background:var(--card);border:1px solid var(--glass-border);padding:28px;border-radius:var(--radius);margin-bottom:24px;box-shadow:0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(212,175,55,0.05);backdrop-filter:blur(20px);transition:all .3s}
    .card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(212,175,55,0.08)}
    .card h4{font-family:'Playfair Display', serif;font-weight:700;color:var(--accent);letter-spacing:-0.5px}
    .grid-2{display:grid;grid-template-columns:1fr 400px;gap:24px}
    .small{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px 16px;text-align:left;border-bottom:1px solid rgba(212,175,55,0.08);font-size:14px;color:var(--white)}
    th{font-size:11px;color:var(--accent);font-weight:700;text-transform:uppercase;background:rgba(212,175,55,0.03);position:sticky;top:0;letter-spacing:1px}
    input,select{background:rgba(212,175,55,0.03);border:1px solid rgba(212,175,55,0.15);color:var(--white);padding:12px 16px;border-radius:var(--radius-sm);transition:all .3s;font-size:14px}
#quickProduto, #quickQtd, #quickValor {color: var(--white) !important;background: rgba(212,175,55,0.05) !important;}
#quickProduto option {background: #1a1625;color: var(--white);}
select option, select optgroup{background:#1a1625;color:var(--white);}
.modal select{color:var(--white) !important;background:rgba(212,175,55,0.05) !important;}
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(212,175,55,0.1);background:rgba(212,175,55,0.05)}
    .pill{background:rgba(212,175,55,0.04);border:1px solid rgba(212,175,55,0.15);padding:20px;border-radius:var(--radius-sm);transition:all .3s;box-shadow:inset 0 1px 0 rgba(212,175,55,0.05)}
    .pill:hover{background:rgba(212,175,55,0.06);border-color:rgba(212,175,55,0.25);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.2), inset 0 1px 0 rgba(212,175,55,0.08)}
    .summary-row{display:flex;gap:16px;flex-wrap:wrap}
    .summary-item{min-width:160px;flex:1}
    .chart-wrap{height:240px;position:relative}
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,12,41,0.92);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;z-index:100;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{background:var(--panel);border:1px solid rgba(212,175,55,0.2);padding:32px;border-radius:var(--radius);width:600px;max-width:90vw;box-shadow:0 30px 90px rgba(0,0,0,0.7), inset 0 1px 0 rgba(212,175,55,0.1);animation:slideUp .3s cubic-bezier(0.4, 0, 0.2, 1)}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .form-row{display:flex;gap:12px}
    .badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;text-transform:uppercase}
    .badge-success{background:rgba(16,185,129,0.12);color:var(--success);border:1px solid rgba(16,185,129,0.15)}
    .badge-danger{background:rgba(239,68,68,0.12);color:var(--danger);border:1px solid rgba(239,68,68,0.15)}
    @media (max-width:1000px){.app{grid-template-columns:1fr;padding:20px}.sidebar{position:relative;order:2;display:flex;flex-direction:row;overflow-x:auto}.nav{flex-direction:row}.content{padding:20px}.search-input{min-width:200px}}
 .chart-wrap-small{height:200px;position:relative;margin-top:16px}
.tab-buttons{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.tab-buttons button{padding:10px 20px;font-size:13px}
 </style>
</head>
<body>
  <!-- LOGIN PAGE -->
  <div id="login-page" style="display:flex;align-items:center;justify-content:center;position:fixed;inset:0;background:linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);z-index:5">
    <div id="login-box" style="width:540px;max-width:90vw;background:var(--panel);padding:40px;border-radius:24px;border:1px solid rgba(212,175,55,0.2);box-shadow:0 40px 100px rgba(0,0,0,0.8), inset 0 1px 0 rgba(212,175,55,0.1);color:var(--white);backdrop-filter:blur(30px)">
      <div style="display:flex;align-items:center;gap:20px;margin-bottom:28px;padding-bottom:24px;border-bottom:2px solid rgba(212,175,55,0.2)">
        <div style="width:72px;height:72px;border-radius:16px;background:var(--gold-gradient);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;color:#1a1625;box-shadow:0 12px 36px rgba(212,175,55,0.35), inset 0 1px 0 rgba(255,255,255,0.3);position:relative">
          E
          <div style="position:absolute;inset:3px;border-radius:13px;border:1px solid rgba(255,255,255,0.2);pointer-events:none"></div>
        </div>
        <div>
          <h2 style="margin:0;font-size:28px;font-family:'Playfair Display',serif;font-weight:800;background:var(--gold-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.5px">Sistema de Estoque</h2>
          <div class="small muted" style="margin-top:4px;font-size:14px">√Årea administrativa ‚Äî insira suas credenciais</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:12px">
        <input id="loginUser" placeholder="Usu√°rio" autocomplete="username" />
        <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <label style="display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px"><input id="remember" type="checkbox"> Lembrar</label>
          <div style="display:flex;gap:12px">
            <button class="btn ghost" id="demoBtn" title="Entrar com demo">Demo</button>
            <button class="btn" id="loginBtn">Entrar</button>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app-root" class="app" style="display:none">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">E</div>
        <div>
          <div class="app-title">EIXO 061</div>
          <div class="small muted" style="font-size:12px;text-transform:uppercase;letter-spacing:2px;color:var(--muted)">Painel Administrativo</div>
        </div>
      </div>

      <nav class="nav" role="navigation" aria-label="Main navigation">
        <button data-page="dashboard" class="active">üìä Dashboard</button>
        <button data-page="estoque">üì¶ Estoque</button>
        <button data-page="vendas">üí∞ Vendas</button>
        <button data-page="analises">üìà An√°lises Avan√ßadas</button>
<button data-page="custos">üí∏ An√°lise de Gastos</button>
        <button data-page="gastos">üí∏ Gastos</button>
        <button data-page="clientes">üë• Clientes</button>
      </nav>

      <div style="margin-top:auto;padding-top:20px;border-top:1px solid var(--glass-border)">
        <div class="small muted" style="margin-bottom:12px">Exportar Dados</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="exportStockBtnSide" class="btn ghost">üì§ Exportar Estoque</button>
          <button id="exportSalesBtnSide" class="btn ghost">üì§ Exportar Vendas</button>
          <button id="clearBtnSide" class="btn ghost">üîÑ Resetar vendas/gastos</button>
          <button id="logoutBtn" class="btn ghost" style="margin-top:8px">üö™ Logout</button>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content" role="main">
      <header class="app-header">
  <div style="display:flex;align-items:center;gap:16px;flex:1">
    <div class="small muted">üë§ Usu√°rio: <strong id="currentUser">-</strong></div>
  </div>
  <div style="display:flex;gap:12px" class="top-actions">
    <button id="newProductBtn" class="btn">‚ú® Novo Produto</button>
  </div>
</header>

      <!-- PAGES -->
      <section id="page-dashboard">
        <div class="grid-2">
          <div>
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div>
                  <div class="small muted">RESUMO R√ÅPIDO</div>
                  <h3 style="margin:8px 0 0 0">Vis√£o Geral do Neg√≥cio</h3>
                </div>
                <div class="small muted">üìÖ √öltimas 24h</div>
              </div>

              <div class="summary-row">
                <div class="pill summary-item">
                  <div class="small muted">Pe√ßas em estoque</div>
                  <div id="totalPecas" style="font-weight:800;font-size:28px;margin-top:8px">0</div>
                </div>
                <div class="pill summary-item">
                  <div class="small muted">Total Investido</div>
                  <div id="totalInvestido" style="font-weight:800;font-size:28px;margin-top:8px">R$ 0,00</div>
                </div>
                <div class="pill summary-item">
                  <div class="small muted">Lucro Bruto</div>
                  <div id="faturamentoReal" style="font-weight:800;font-size:28px;margin-top:8px">R$ 0,00</div>
                </div>
                <div class="pill summary-item">
                  <div class="small muted">Lucro L√≠quido</div>
                  <div id="lucroReal" style="font-weight:800;font-size:28px;margin-top:8px">R$ 0,00</div>
                </div>
              </div>
            </div>

            <div class="card">
              <h4 style="margin:0 0 16px 0">üíπ Fluxo de Caixa</h4>
              <div class="chart-wrap"><canvas id="grafPizza"></canvas></div>
              <div id="resumoPizza" style="margin-top:16px" class="small muted"></div>
            </div>

            <div class="card">
              <h4 style="margin:0 0 16px 0">üèÜ Produtos Mais Vendidos</h4>
              <ul id="rankingProdutos" style="padding-left:20px;margin:0" class="small"></ul>
            </div>
          </div>

          <aside>
            <div class="card">
              <h4 style="margin:0 0 16px 0">‚ö° Venda R√°pida</h4>
              <div style="display:flex;flex-direction:column;gap:12px">
                <label class="small muted">PRODUTO</label>
                <select id="quickProduto"></select>
                <label class="small muted" style="margin-top:8px">CLIENTE</label>
<input id="quickCliente" list="clientesList" placeholder="Digite o nome do cliente..." autocomplete="off" />
<datalist id="clientesList"></datalist>
                <div style="display:flex;gap:12px">
                  <div style="flex:1">
                    <label class="small muted">QUANTIDADE</label>
                    <input id="quickQtd" type="number" min="1" value="1" style="width:100%;margin-top:6px" />
                  </div>
                  <div style="flex:1">
                    <label class="small muted">VALOR (R$)</label>
                    <input id="quickValor" type="number" min="0" step="0.01" placeholder="0,00" style="width:100%;margin-top:6px" />
                  </div>
                </div>
                <button id="quickAddBtn" class="btn" style="margin-top:8px">üí≥ Registrar Venda</button>
                <div class="small muted" style="margin-top:4px">‚úì Venda r√°pida ‚Äî subtrai do estoque automaticamente</div>
              </div>
            </div>

            <div class="card">
  <h4 style="margin:0 0 16px 0">üí∏ Registrar Gastos</h4>
  <form id="gastoFormSide" style="display:flex;flex-direction:column;gap:12px">
    <input id="gastoDescSide" placeholder="Descri√ß√£o do gasto" required />
    <input id="gastoValorSide" type="number" min="0" step="0.01" placeholder="Valor (R$)" required />
    <select id="gastoFormaPagSide" required>
      <option value="">Forma de pagamento</option>
      <option value="Dinheiro">üíµ Dinheiro</option>
      <option value="D√©bito">üí≥ D√©bito</option>
      <option value="Cr√©dito">üí≥ Cr√©dito</option>
      <option value="PIX">üì± PIX</option>
      <option value="Boleto">üìÑ Boleto</option>
      <option value="Transfer√™ncia">üè¶ Transfer√™ncia</option>
    </select>
    <input id="gastoObsSide" placeholder="Observa√ß√£o (opcional)" />
    <button type="submit" class="btn ghost">‚ûï Adicionar Gasto</button>
  </form>
</div>
          </aside>
        </div>
      </section>

      <!-- ESTOQUE PAGE -->
      <section id="page-estoque" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">üì¶ Gest√£o de Estoque</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="filterStock" placeholder="üîç Buscar no estoque..." />
           <select id="filterTamanho">
  <option value="">Todos tamanhos</option>
  <optgroup label="An√©is">
    <option>12</option>
    <option>14</option>
    <option>16</option>
    <option>18</option>
    <option>20</option>
    <option>22</option>
  </optgroup>
  <optgroup label="Colares/Pulseiras">
    <option>40cm</option>
    <option>45cm</option>
    <option>50cm</option>
    <option>55cm</option>
    <option>60cm</option>
  </optgroup>
  <optgroup label="Outros">
    <option>√önico</option>
  </optgroup>
</select>
            <button id="newProductBtn2" class="btn">‚ú® Novo</button>
          </div>
        </div>

        <div class="card">
          <div style="overflow:auto;max-height:420px">
            <table id="stockTable">
              <thead>
                <tr><th>Tipo</th><th>Material</th><th>Tamanho</th><th>Qtd</th><th>Custo</th><th>Pre√ßo</th><th>Lucro/unid</th><th>A√ß√µes</th></tr>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- VENDAS PAGE -->
      <section id="page-vendas" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Vendas (Hist√≥rico)</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="filterSales" placeholder="Buscar vendas..." />
            <select id="filterEstorno"><option value="all">Todos</option><option value="active">Ativas</option><option value="estornado">Estornadas</option></select>
            <button id="exportSalesBtnTop" class="btn ghost">Exportar CSV</button>
          </div>
        </div>

        <div class="card">
          <div style="overflow:auto;max-height:520px">
            <table id="salesTable">
              <thead><tr><th>Data</th><th>Produto</th><th>Qtd</th><th>Valor total</th><th>Lucro</th><th>A√ß√£o</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- RELAT√ìRIOS PAGE -->
      <section id="page-relatorios" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Relat√≥rios</h3>
          <div class="small muted">Exportar / Analisar</div>
        </div>

        <div class="card">
          <h4>Resumo Financeiro</h4>
          <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
            <div class="pill"><div class="small muted">Faturamento realizado</div><div id="rel_faturamento" style="font-weight:700">R$ 0,00</div></div>
            <div class="pill"><div class="small muted">Gastos</div><div id="rel_gastos" style="font-weight:700">R$ 0,00</div></div>
            <div class="pill"><div class="small muted">Custo produtos vendidos</div><div id="rel_custos" style="font-weight:700">R$ 0,00</div></div>
            <div class="pill"><div class="small muted">Lucro l√≠quido</div><div id="rel_lucro" style="font-weight:700">R$ 0,00</div></div>
          </div>
          <div style="margin-top:12px">
            <button id="exportPdfBtn" class="btn ghost">Exportar PDF (simulado)</button>
            <button id="exportXlsxBtn" class="btn ghost">Exportar XLSX (simulado)</button>
          </div>
        </div>
      </section>
<!-- AN√ÅLISES AVAN√áADAS PAGE -->
<section id="page-analises" style="display:none">
  <h3 style="margin:0 0 20px 0">üìà An√°lises Avan√ßadas</h3>
  
  <!-- Vendas por Per√≠odo -->
  <div class="card">
    <h4 style="margin:0 0 16px 0">üìä Vendas por Per√≠odo</h4>
    <div class="tab-buttons">
      <button class="btn ghost active" data-periodo="mes">Mensal</button>
      <button class="btn ghost" data-periodo="trimestre">Trimestral</button>
      <button class="btn ghost" data-periodo="semestre">Semestral</button>
    </div>
    <div class="chart-wrap"><canvas id="grafVendasPeriodo"></canvas></div>
  </div>

  <!-- Indicadores com Gr√°ficos -->
  <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:24px">
    <div class="card">
      <h4 style="margin:0 0 8px 0">üì¶ Pe√ßas em Estoque</h4>
      <div style="font-size:32px;font-weight:800;margin:12px 0" id="analise_pecas">0</div>
      <div class="chart-wrap-small"><canvas id="grafPecasEstoque"></canvas></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">üí∞ Total Investido</h4>
      <div style="font-size:32px;font-weight:800;margin:12px 0" id="analise_investido">R$ 0,00</div>
      <div class="chart-wrap-small"><canvas id="grafInvestido"></canvas></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">üíµ Lucro Bruto</h4>
      <div style="font-size:32px;font-weight:800;margin:12px 0" id="analise_bruto">R$ 0,00</div>
      <div class="chart-wrap-small"><canvas id="grafLucroBruto"></canvas></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">‚ú® Lucro L√≠quido</h4>
      <div style="font-size:32px;font-weight:800;margin:12px 0" id="analise_liquido">R$ 0,00</div>
      <div class="chart-wrap-small"><canvas id="grafLucroLiquido"></canvas></div>
    </div>
  </div>
</section>

<!-- AN√ÅLISE DE CUSTOS PAGE -->
<section id="page-custos" style="display:none">
  <h3 style="margin:0 0 20px 0">üí∏ An√°lise Detalhada de Gastos</h3>
  
  <div class="card">
    <h4 style="margin:0 0 16px 0">üìä Distribui√ß√£o de Gastos por Categoria</h4>
    <div class="chart-wrap"><canvas id="grafCustosDistribuicao"></canvas></div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px">
    <div class="card">
      <h4 style="margin:0 0 16px 0">üî∫ Maiores Gastos</h4>
      <div id="listaMaioresCustos" style="display:flex;flex-direction:column;gap:12px"></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 16px 0">üîª Menores Gastos</h4>
      <div id="listaMenoresCustos" style="display:flex;flex-direction:column;gap:12px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:24px">
    <h4 style="margin:0 0 16px 0">üìã Hist√≥rico Completo de Gastos</h4>
    <table>
      <thead>
        <tr>
          <th>Descri√ß√£o</th>
          <th>Valor</th>
          <th>Data</th>
          <th>Forma de Pagamento</th>
        </tr>
      </thead>
      <tbody id="tabelaCustos"></tbody>
    </table>
  </div>
</section>
      <!-- GASTOS PAGE -->
      <section id="page-gastos" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">üí∏ Gest√£o de Gastos</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="filterGastos" placeholder="üîç Buscar gastos..." />
            <select id="filterFormaPag">
              <option value="">Todas formas</option>
              <option value="Dinheiro">üíµ Dinheiro</option>
              <option value="D√©bito">üí≥ D√©bito</option>
              <option value="Cr√©dito">üí≥ Cr√©dito</option>
              <option value="PIX">üì± PIX</option>
              <option value="Boleto">üìÑ Boleto</option>
              <option value="Transfer√™ncia">üè¶ Transfer√™ncia</option>
            </select>
            <button id="exportGastosBtn" class="btn ghost">üì§ Exportar CSV</button>
          </div>
        </div>

        <div class="card">
          <div style="overflow:auto;max-height:520px">
            <table id="gastosTable">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Gasto</th>
                  <th>Valor</th>
                  <th>Forma de Pagamento</th>
                  <th>Observa√ß√£o</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLIENTES PAGE -->
      <section id="page-clientes" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">üë• Gest√£o de Clientes</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="filterClientes" placeholder="üîç Buscar clientes..." />
            <button id="newClientBtn" class="btn">‚ú® Novo Cliente</button>
          </div>
        </div>

        <div class="card">
          <div style="overflow:auto;max-height:520px">
            <table id="clientesTable">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Telefone</th>
                  <th>Total em Compras</th>
                  <th>√öltima Compra</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>  <!-- ‚úÖ main fecha DEPOIS de todas as p√°ginas -->
  </div>
  
  <!-- MODAL -->>
  <div id="modal-root" style="display:none"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
  /***************************
   * Unified Inventory App (final)
   ***************************/
  const STORAGE_KEYS = { stock: 'loja_stock_v1', sales: 'loja_sales_v1' };
  const CREDENTIALS = { user: 'eixo', pass: '1234@' };

  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
  function loadData(key){ const raw = localStorage.getItem(key); try{ return raw ? JSON.parse(raw) : []; }catch(e){ console.warn('parse error', key); return []; } }
  function saveData(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
  function saveGastos(gastos){ localStorage.setItem('loja_gastos_v1', JSON.stringify(gastos)); }
  function saveCustosVendidos(v){ localStorage.setItem('loja_custos_vendidos_v1', String(v)); }
  function moneyFmt(n){ return Number(n).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function moneyLabel(n){ return 'R$ ' + moneyFmt(n||0); }

  let stock = loadData(STORAGE_KEYS.stock);
  let sales = loadData(STORAGE_KEYS.sales);
  let gastos = JSON.parse(localStorage.getItem('loja_gastos_v1') || '[]');
  let custosProdutosVendidos = Number(localStorage.getItem('loja_custos_vendidos_v1') || 0);
  let clientes = JSON.parse(localStorage.getItem('loja_clientes_v1') || '[]');
function saveClientes(data){ localStorage.setItem('loja_clientes_v1', JSON.stringify(data)); }
  let currentUser = null;
  let grafPizza = null;

  // DOM refs
  const loginPage = document.getElementById('login-page');
  const loginBtn = document.getElementById('loginBtn');
  const demoBtn = document.getElementById('demoBtn');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const remember = document.getElementById('remember');

  const appRoot = document.getElementById('app-root');
  const navButtons = document.querySelectorAll('.nav button[data-page]');
  const pageDashboard = document.getElementById('page-dashboard');
  const pageEstoque = document.getElementById('page-estoque');
  const pageVendas = document.getElementById('page-vendas');
  const pageRelatorios = document.getElementById('page-relatorios');
  const currentUserEl = document.getElementById('currentUser');

  const exportStockBtnSide = document.getElementById('exportStockBtnSide');
  const exportSalesBtnSide = document.getElementById('exportSalesBtnSide');
  const clearBtnSide = document.getElementById('clearBtnSide');
  const globalSearch = document.getElementById('globalSearch');
  const newProductBtn = document.getElementById('newProductBtn');
  const newProductBtn2 = document.getElementById('newProductBtn2');

  const totalPecasEl = document.getElementById('totalPecas');
  const totalInvestidoEl = document.getElementById('totalInvestido');
  const faturamentoRealEl = document.getElementById('faturamentoReal');
  const lucroRealEl = document.getElementById('lucroReal');
  const rankingProdutosEl = document.getElementById('rankingProdutos');
  const resumoPizzaEl = document.getElementById('resumoPizza');

  quickProduto.addEventListener('change', ()=>{
  const pid = quickProduto.value;
  if(!pid) return;
  const produto = stock.find(s=>s.id===pid);
  if(produto) quickValor.value = produto.preco;
});
  const quickQtd = document.getElementById('quickQtd');
  const quickValor = document.getElementById('quickValor');
  const quickAddBtn = document.getElementById('quickAddBtn');

  const stockTableBody = document.querySelector('#stockTable tbody');
  const filterStock = document.getElementById('filterStock');
  const filterTamanho = document.getElementById('filterTamanho');

  const salesTableBody = document.querySelector('#salesTable tbody');
  const filterSales = document.getElementById('filterSales');
  const filterEstorno = document.getElementById('filterEstorno');

  const gastoFormSide = document.getElementById('gastoFormSide');
  gastoFormSide?.addEventListener('submit', (e) => {
  e.preventDefault();
  
  const desc = gastoDescSide.value.trim();
  const val = Number(gastoValorSide.value) || 0;
  const formaPagamento = document.getElementById('gastoFormaPagSide').value;
  const observacao = document.getElementById('gastoObsSide').value.trim();
  
  if(!desc || val <= 0 || !formaPagamento) {
    return alert('Preencha todos os campos obrigat√≥rios.');
  }
  
  gastos.push({ 
    id: uid(), 
    date: new Date().toISOString(), 
    desc, 
    valor: val,
    formaPagamento,
    observacao
  });
  
  saveGastos(gastos);
  gastoFormSide.reset();
  renderAll();
  alert(`Gasto de ${moneyLabel(val)} registrado com sucesso!`);
});
  const gastoDescSide = document.getElementById('gastoDescSide');
  const gastoValorSide = document.getElementById('gastoValorSide');

  const modalRoot = document.getElementById('modal-root');

  // chart plugin (center text)
  const centerTextPlugin = {
    id: 'centerTextPlugin',
    afterDraw(chart, args, options) {
      const {ctx, chartArea: {left, right, top, bottom}} = chart;
      ctx.save();
      const centerX = (left + right) / 2;
      const centerY = (top + bottom) / 2;
      ctx.textAlign = 'center';
      ctx.fillStyle = options.color || '#f0f4f8';
      ctx.font = `700 14px Inter, system-ui`;
      ctx.fillText(options.title || '', centerX, centerY - 8);
      ctx.font = `800 18px Inter, system-ui`;
      ctx.fillText(options.value || '', centerX, centerY + 18);
      ctx.restore();
    }
  };
  Chart.register(centerTextPlugin);

  // AUTH
  function showApp(user){
    currentUser = user;
    currentUserEl.textContent = user;
    loginPage.style.display = 'none';
    appRoot.style.display = 'grid';
    renderAll();
  }

  loginBtn.addEventListener('click', ()=>{
    const u = loginUser.value.trim();
    const p = loginPass.value;
    if(u === CREDENTIALS.user && p === CREDENTIALS.pass){
      showApp(u);
      if(remember.checked) localStorage.setItem('loja_last_user', u);
    } else {
      alert('Usu√°rio ou senha incorretos.');
    }
  });
  demoBtn.addEventListener('click', ()=>{ loginUser.value = CREDENTIALS.user; loginPass.value = CREDENTIALS.pass; loginBtn.click(); });

  if(localStorage.getItem('loja_last_user') === CREDENTIALS.user){
    loginUser.value = CREDENTIALS.user;
    loginPass.value = CREDENTIALS.pass;
    showApp(CREDENTIALS.user);
  }

  document.getElementById('logoutBtn').addEventListener('click', ()=>{ if(confirm('Encerrar sess√£o?')){ currentUser = null; appRoot.style.display='none'; loginPage.style.display='flex'; } });

  // NAV
  navButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      navButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      showPage(btn.dataset.page);
    });
  });
  function showPage(page){
  pageDashboard.style.display = page === 'dashboard' ? '' : 'none';
  pageEstoque.style.display = page === 'estoque' ? '' : 'none';
  pageVendas.style.display = page === 'vendas' ? '' : 'none';
  
  const pageAnalises = document.getElementById('page-analises');
  if(pageAnalises) pageAnalises.style.display = page === 'analises' ? '' : 'none';
  
  const pageCustos = document.getElementById('page-custos');
  if(pageCustos) pageCustos.style.display = page === 'custos' ? '' : 'none';
  
  const pageGastos = document.getElementById('page-gastos');
  if(pageGastos) pageGastos.style.display = page === 'gastos' ? '' : 'none';
  
  const pageClientes = document.getElementById('page-clientes');
  if(pageClientes) pageClientes.style.display = page === 'clientes' ? '' : 'none';
  
  // Renderizar gr√°ficos quando entrar nas p√°ginas
  if(page === 'analises') renderAnalises();
  if(page === 'custos') renderCustos();
}

  // RENDER HELPERS
  function buildProductOptionList(){
    const selects = [quickProduto, document.getElementById('carrinhoProduto')].filter(Boolean);
    selects.forEach(s=>{
      s.innerHTML = '';
      stock.filter(it => Number(it.qtd) > 0).forEach(it=>{
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = `${it.modelo} ‚Äî ${it.cor} ‚Äî ${it.tamanho} (qtd: ${it.qtd})`;
        s.appendChild(opt);
      });
    });
  }
function atualizarListaClientes(){
  const datalist = document.getElementById('clientesList');
  if(!datalist) return;
  datalist.innerHTML = '';
  clientes.forEach(c => {
    const option = document.createElement('option');
    option.value = c.nome;
    datalist.appendChild(option);
  });
}
  function renderStock(){
    stockTableBody.innerHTML = '';
    const q = (filterStock.value||'').toLowerCase();
    const t = filterTamanho.value;
    const list = stock.filter(it=>{
      if(t && it.tamanho !== t) return false;
      if(!q) return true;
      return [it.modelo, it.cor, it.tamanho].join(' ').toLowerCase().includes(q);
    });
    if(list.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="8" class="muted">Nenhum item no estoque.</td>`;
      stockTableBody.appendChild(tr);
      return;
    }
    list.forEach(item=>{
      const lucroUnit = Number(item.preco) - Number(item.custo);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.modelo}</td>
        <td>${item.cor}</td>
        <td>${item.tamanho}</td>
        <td><input class="inline-qtd" data-id="${item.id}" type="number" min="0" value="${item.qtd}" style="width:80px;padding:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--white)"></td>
        <td>${moneyLabel(item.custo)}</td>
        <td>${moneyLabel(item.preco)}</td>
        <td>${moneyLabel(lucroUnit)}</td>
        <td style="white-space:nowrap">
          <button class="btn ghost btn-edit" data-id="${item.id}">Editar</button>
          <button class="btn ghost btn-remove" data-id="${item.id}">Remover</button>
        </td>`;
      stockTableBody.appendChild(tr);
    });

    // attach listeners
    document.querySelectorAll('.inline-qtd').forEach(inp=>{
      inp.addEventListener('change', (e)=>{
        const id = e.target.dataset.id;
        const val = Number(e.target.value) || 0;
        const idx = stock.findIndex(s=>s.id===id);
        if(idx>=0){ stock[idx].qtd = val; saveData(STORAGE_KEYS.stock, stock); renderAll(); }
      });
    });
    

    document.querySelectorAll('.btn-edit').forEach(b=>b.addEventListener('click', (e)=> openProductModal(b.dataset.id)));
    document.querySelectorAll('.btn-remove').forEach(b=>b.addEventListener('click', (e)=>{
      const id = b.dataset.id;
      if(!confirm('Remover item do estoque? Esta a√ß√£o √© permanente.')) return;
      stock = stock.filter(s=>s.id!==id);
      saveData(STORAGE_KEYS.stock, stock);
      renderAll();
    }));
    buildProductOptionList();
  }

  function renderSales(){
    salesTableBody.innerHTML = '';
    const q = (filterSales.value||'').toLowerCase();
    const est = filterEstorno.value;
    const list = sales.slice().reverse().filter(s=>{
      if(est === 'active' && s.estornado) return false;
      if(est === 'estornado' && !s.estornado) return false;
      if(!q) return true;
      return (s.nome + ' ' + (s.date || '')).toLowerCase().includes(q);
    });
    if(list.length === 0){
      salesTableBody.innerHTML = `<tr><td colspan="6" class="muted">Nenhuma venda registrada.</td></tr>`;
      return;
    }
    list.forEach(s=>{
      const estClass = s.estornado ? 'color:var(--muted);opacity:0.6;text-decoration:line-through' : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="${estClass}">${new Date(s.date).toLocaleString()}</td>
        <td style="${estClass}">${s.nome}</td>
        <td style="${estClass}">${s.qtd}</td>
        <td style="${estClass}">${moneyLabel(s.valorTotal)}</td>
        <td style="${estClass}">${moneyLabel(s.lucro)}</td>
        <td style="white-space:nowrap">
          <button class="btn ghost btn-toggle-estorno" data-id="${s.id}" style="min-width:110px">${s.estornado ? 'Reaplicar' : 'Estornar'}</button>
        </td>`;
      salesTableBody.appendChild(tr);
    });

    document.querySelectorAll('.btn-toggle-estorno').forEach(b=>{
      b.addEventListener('click', ()=> toggleEstorno(b.dataset.id));
    });
  }

  function calcularResumo(){
    const totalPecas = stock.reduce((a,b)=>a + Number(b.qtd), 0);
    const totalInvestido = stock.reduce((a,b)=>a + (Number(b.custo) * Number(b.qtd)), 0);
    const faturamentoReal = sales.filter(s=>!s.estornado).reduce((a,b)=>a + Number(b.valorTotal), 0);
    const lucroVendas = sales.filter(s=>!s.estornado).reduce((a,b)=>a + Number(b.lucro), 0);
    const totalGastos = gastos.reduce((a,b)=>a + Number(b.valor), 0);
    const lucroReal = faturamentoReal - custosProdutosVendidos - totalGastos; // ‚úÖ C√ÅLCULO CORRETO

    totalPecasEl.textContent = totalPecas;
    totalInvestidoEl.textContent = moneyLabel(totalInvestido);
    faturamentoRealEl.textContent = moneyLabel(faturamentoReal);
    lucroRealEl.textContent = moneyLabel(lucroReal);

    document.getElementById('rel_faturamento').textContent = moneyLabel(faturamentoReal);
    document.getElementById('rel_gastos').textContent = moneyLabel(totalGastos);
    document.getElementById('rel_custos').textContent = moneyLabel(custosProdutosVendidos);
    document.getElementById('rel_lucro').textContent = moneyLabel(faturamentoReal - custosProdutosVendidos - totalGastos);
  }

  function atualizarPizza(){
    const faturamento = sales.filter(s=>!s.estornado).reduce((a,b)=>a + Number(b.valorTotal), 0);
    const custoProdutos = custosProdutosVendidos;
    const gastosExtras = gastos.reduce((a,b)=>a + Number(b.valor), 0);
    const lucroLiquido = faturamento - custoProdutos - gastosExtras;
    const canvas = document.getElementById("grafPizza");
    const ctx = canvas.getContext("2d");

    const g1 = ctx.createLinearGradient(0,0,0,200); g1.addColorStop(0, '#5eead4'); g1.addColorStop(1, '#10b981');
    const g2 = ctx.createLinearGradient(0,0,0,200); g2.addColorStop(0, '#fca5a5'); g2.addColorStop(1, '#ef4444');
    const g3 = ctx.createLinearGradient(0,0,0,200); g3.addColorStop(0, '#fef3c7'); g3.addColorStop(1, '#f59e0b');
    const g4pos = ctx.createLinearGradient(0,0,0,200); g4pos.addColorStop(0, '#93c5fd'); g4pos.addColorStop(1, '#3b82f6');
    const g4neg = ctx.createLinearGradient(0,0,0,200); g4neg.addColorStop(0, '#fca5a5'); g4neg.addColorStop(1, '#ef4444');
    const lucroColor = lucroLiquido >= 0 ? g4pos : g4neg;

    // ‚úÖ CORRE√á√ÉO: Mostrar apenas os 3 valores reais (sem somar o lucro)
    const values = [faturamento, custoProdutos, gastosExtras];
    const total = values.reduce((a,b)=>a+b,0);
    const displayValues = total === 0 ? [1,0,0] : values;

    if(grafPizza) grafPizza.destroy();
    grafPizza = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Faturamento', 'Custo Produtos', 'Gastos Extras'],
        datasets: [{ data: displayValues, backgroundColor: [g1,g2,g3], borderColor:'#071022', borderWidth:2 }]
      },
      options: {
        cutout:'62%', responsive:true, maintainAspectRatio:false,
        plugins: {
          legend:{position:'bottom', labels:{color:'#e6eef6'}},
          centerTextPlugin: { title: lucroLiquido >= 0 ? 'Lucro l√≠quido' : 'Preju√≠zo', value: `R$ ${moneyFmt(Math.abs(lucroLiquido))}`, color: lucroLiquido >= 0 ? '#10b981' : '#ef4444' }
        }
      }
    });

    resumoPizzaEl.innerHTML = `<div class="small muted"><strong>Faturamento:</strong> ${moneyLabel(faturamento)} ‚Äî <strong>Custo vendido:</strong> ${moneyLabel(custoProdutos)} ‚Äî <strong>Gastos:</strong> ${moneyLabel(gastosExtras)} ‚Äî <strong>Lucro l√≠quido:</strong> ${moneyLabel(lucroLiquido)}</div>`;
  }

  function atualizarRanking(){
    const contagem = {};
    sales.filter(s=>!s.estornado).forEach(s=>{ contagem[s.nome] = (contagem[s.nome]||0) + Number(s.qtd); });
    const lista = Object.entries(contagem).sort((a,b)=>b[1]-a[1]).slice(0,10);
    rankingProdutosEl.innerHTML = '';
    if(lista.length===0){ rankingProdutosEl.innerHTML = '<li class="muted">Nenhuma venda registrada ainda.</li>'; return; }
    lista.forEach(([nome,qtd])=>{ const li = document.createElement('li'); li.textContent = `${nome} ‚Äî ${qtd} vendidos`; rankingProdutosEl.appendChild(li); });
  }
// ========== RENDERIZA√á√ÉO DE GASTOS ==========
function renderGastos(){
  const gastosTableBody = document.querySelector('#gastosTable tbody');
  if(!gastosTableBody) return;

  gastosTableBody.innerHTML = '';
  const q = (document.getElementById('filterGastos')?.value || '').toLowerCase();
  const formaPag = document.getElementById('filterFormaPag')?.value || '';

  const list = gastos.slice().reverse().filter(g => {
    if(formaPag && g.formaPagamento !== formaPag) return false;
    if(!q) return true;
    return (g.desc + ' ' + g.observacao).toLowerCase().includes(q);
  });

  if(list.length === 0){
    gastosTableBody.innerHTML = `<tr><td colspan="6" class="muted">Nenhum gasto registrado.</td></tr>`;
    return;
  }

  list.forEach(g => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(g.date).toLocaleString('pt-BR')}</td>
      <td>${g.desc}</td>
      <td>${moneyLabel(g.valor)}</td>
      <td>${g.formaPagamento || '-'}</td>
      <td class="small muted">${g.observacao || '-'}</td>
      <td style="white-space:nowrap">
        <button class="btn ghost btn-edit-gasto" data-id="${g.id}">Editar</button>
        <button class="btn ghost btn-remove-gasto" data-id="${g.id}">Remover</button>
      </td>
    `;
    gastosTableBody.appendChild(tr);
  });

  document.querySelectorAll('.btn-edit-gasto').forEach(btn => {
    btn.addEventListener('click', () => openGastoModal(btn.dataset.id));
  });

  document.querySelectorAll('.btn-remove-gasto').forEach(btn => {
    btn.addEventListener('click', () => {
      if(!confirm('Remover este gasto?')) return;
      gastos = gastos.filter(g => g.id !== btn.dataset.id);
      saveGastos(gastos);
      renderAll();
    });
  });
}

// ========== MODAL DE GASTOS ==========
function openGastoModal(gastoId) {
  modalRoot.innerHTML = '';
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';
  
  const isEdit = !!gastoId;
  const gasto = isEdit ? gastos.find(g => g.id === gastoId) : null;

  modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0">${isEdit ? 'Editar Gasto' : 'Novo Gasto'}</h3>
      <button class="btn ghost" id="closeModal">Fechar</button>
    </div>
    <form id="gastoForm" style="display:flex;flex-direction:column;gap:12px">
      <div>
        <label class="small muted">DESCRI√á√ÉO</label>
        <input id="m_gastoDesc" placeholder="Descri√ß√£o do gasto" required style="margin-top:6px" />
      </div>
      <div>
        <label class="small muted">VALOR (R$)</label>
        <input id="m_gastoValor" type="number" min="0" step="0.01" placeholder="0,00" required style="margin-top:6px" />
      </div>
      <div>
        <label class="small muted">FORMA DE PAGAMENTO</label>
        <select id="m_gastoFormaPag" required style="margin-top:6px">
          <option value="">Selecione...</option>
          <option value="Dinheiro">üíµ Dinheiro</option>
          <option value="D√©bito">üí≥ D√©bito</option>
          <option value="Cr√©dito">üí≥ Cr√©dito</option>
          <option value="PIX">üì± PIX</option>
          <option value="Boleto">üìÑ Boleto</option>
          <option value="Transfer√™ncia">üè¶ Transfer√™ncia</option>
        </select>
      </div>
      <div>
        <label class="small muted">OBSERVA√á√ÉO (OPCIONAL)</label>
        <input id="m_gastoObs" placeholder="Observa√ß√£o adicional" style="margin-top:6px" />
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button type="submit" class="btn">${isEdit ? 'Salvar Altera√ß√µes' : 'Adicionar Gasto'}</button>
      </div>
    </form>
  `;

  backdrop.appendChild(modal);
  modalRoot.appendChild(backdrop);
  modalRoot.style.display = 'block';

  if (isEdit && gasto) {
    document.getElementById('m_gastoDesc').value = gasto.desc;
    document.getElementById('m_gastoValor').value = gasto.valor;
    document.getElementById('m_gastoFormaPag').value = gasto.formaPagamento || '';
    document.getElementById('m_gastoObs').value = gasto.observacao || '';
  }

  document.getElementById('closeModal').addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeModal();
  });

  document.getElementById('gastoForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const novoGasto = {
      id: isEdit ? gastoId : uid(),
      date: isEdit ? gasto.date : new Date().toISOString(),
      desc: document.getElementById('m_gastoDesc').value.trim(),
      valor: Number(document.getElementById('m_gastoValor').value) || 0,
      formaPagamento: document.getElementById('m_gastoFormaPag').value,
      observacao: document.getElementById('m_gastoObs').value.trim()
    };

    if (!novoGasto.desc || novoGasto.valor <= 0 || !novoGasto.formaPagamento) {
      return alert('Preencha todos os campos obrigat√≥rios.');
    }

    if (isEdit) {
      const idx = gastos.findIndex(g => g.id === gastoId);
      if (idx >= 0) gastos[idx] = novoGasto;
    } else {
      gastos.push(novoGasto);
    }

    saveGastos(gastos);
    renderAll();
    closeModal();
  });

  function closeModal() {
    modalRoot.innerHTML = '';
    modalRoot.style.display = 'none';
  }
}

// ========== MODAL DE CLIENTES ==========
function openClienteModal(clienteId){
  modalRoot.innerHTML = '';
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';
  
  const isEdit = !!clienteId;
  const cliente = isEdit ? clientes.find(c => c.id === clienteId) : null;

  modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0">${isEdit ? 'Editar Cliente' : 'Novo Cliente'}</h3>
      <button class="btn ghost" id="closeModal">Fechar</button>
    </div>
    <form id="clienteForm" style="display:flex;flex-direction:column;gap:12px">
      <div>
        <label class="small muted">NOME COMPLETO</label>
        <input id="m_clienteNome" placeholder="Nome do cliente" required style="margin-top:6px" />
      </div>
      <div>
        <label class="small muted">TELEFONE</label>
        <input id="m_clienteTelefone" placeholder="(00) 00000-0000" style="margin-top:6px" />
      </div>
      <div>
        <label class="small muted">OBSERVA√á√ïES</label>
        <textarea id="m_clienteObs" placeholder="Anota√ß√µes sobre o cliente..." rows="3" style="margin-top:6px;background:rgba(212,175,55,0.03);border:1px solid rgba(212,175,55,0.15);color:var(--white);padding:12px;border-radius:var(--radius-sm);resize:vertical"></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button type="submit" class="btn">${isEdit ? 'Salvar Altera√ß√µes' : 'Adicionar Cliente'}</button>
      </div>
    </form>
  `;

  backdrop.appendChild(modal);
  modalRoot.appendChild(backdrop);
  modalRoot.style.display = 'block';

  if(isEdit && cliente){
    document.getElementById('m_clienteNome').value = cliente.nome;
    document.getElementById('m_clienteTelefone').value = cliente.telefone || '';
    document.getElementById('m_clienteObs').value = cliente.observacoes || '';
  }

  document.getElementById('closeModal').addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e) => { if(e.target === backdrop) closeModal(); });

  document.getElementById('clienteForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const novoCliente = {
      id: isEdit ? clienteId : uid(),
      nome: document.getElementById('m_clienteNome').value.trim(),
      telefone: document.getElementById('m_clienteTelefone').value.trim(),
      observacoes: document.getElementById('m_clienteObs').value.trim(),
      compras: isEdit ? cliente.compras : [],
      totalGasto: isEdit ? cliente.totalGasto : 0,
      ultimaCompra: isEdit ? cliente.ultimaCompra : null
    };

    if(!novoCliente.nome){
      return alert('Informe o nome do cliente.');
    }

    if(isEdit){
      const idx = clientes.findIndex(c => c.id === clienteId);
      if(idx >= 0) clientes[idx] = novoCliente;
    } else {
      clientes.push(novoCliente);
    }

    saveClientes(clientes);
    renderAll();
    closeModal();
  });

  function closeModal(){
    modalRoot.innerHTML = '';
    modalRoot.style.display = 'none';
  }
}

// ========== RENDERIZA√á√ÉO DE CLIENTES ==========
function renderClientes(){
  const clientesTableBody = document.querySelector('#clientesTable tbody');
  if(!clientesTableBody) return;
  
  clientesTableBody.innerHTML = '';
  const q = (document.getElementById('filterClientes')?.value || '').toLowerCase();
  
  const list = clientes.filter(c => {
    if(!q) return true;
    return (c.nome + ' ' + c.telefone).toLowerCase().includes(q);
  });
  
  if(list.length === 0){
    clientesTableBody.innerHTML = `<tr><td colspan="5" class="muted">Nenhum cliente cadastrado.</td></tr>`;
    return;
  }
  
  list.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${c.nome}</strong></td>
      <td>${c.telefone || '-'}</td>
      <td>${moneyLabel(c.totalGasto || 0)}</td>
      <td class="small muted">${c.ultimaCompra ? new Date(c.ultimaCompra).toLocaleDateString('pt-BR') : '-'}</td>
      <td style="white-space:nowrap">
        <button class="btn ghost btn-edit-cliente" data-id="${c.id}">Editar</button>
        <button class="btn ghost btn-remove-cliente" data-id="${c.id}">Remover</button>
      </td>
    `;
    clientesTableBody.appendChild(tr);
  });
  
  document.querySelectorAll('.btn-edit-cliente').forEach(btn => {
    btn.addEventListener('click', () => openClienteModal(btn.dataset.id));
  });
  
  document.querySelectorAll('.btn-remove-cliente').forEach(btn => {
    btn.addEventListener('click', () => {
      if(!confirm('Remover este cliente?')) return;
      clientes = clientes.filter(c => c.id !== btn.dataset.id);
      saveClientes(clientes);
      renderAll();
    });
  });
}

// ========== MODAL DE PRODUTO ==========
function openProductModal(productId){
  modalRoot.innerHTML = '';
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';
  const isEdit = !!productId;
  const product = isEdit ? stock.find(s=>s.id===productId) : null;

  modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0">${isEdit ? 'Editar produto' : 'Novo produto'}</h3>
      <button class="btn ghost" id="closeModal">Fechar</button>
    </div>
    <form id="productForm" style="display:flex;flex-direction:column;gap:8px">
      <div class="form-row">
        <div class="col"><label class="small muted">Tipo/Modelo</label><input id="m_modelo" placeholder="Ex: Anel solit√°rio, Colar corrente" required /></div>
        <div class="col"><label class="small muted">Material/Pedra</label><input id="m_cor" placeholder="Ex: Ouro 18k, Prata 925" required /></div>
      </div>
      <div class="form-row">
        <div class="col"><label class="small muted">Tamanho</label><select id="m_tamanho">
          <optgroup label="An√©is">
            <option>12</option>
            <option>14</option>
            <option>16</option>
            <option>18</option>
            <option>20</option>
            <option>22</option>
          </optgroup>
          <optgroup label="Colares/Pulseiras">
            <option>40cm</option>
            <option>45cm</option>
            <option>50cm</option>
            <option>55cm</option>
            <option>60cm</option>
          </optgroup>
          <optgroup label="Outros">
            <option>√önico</option>
          </optgroup>
        </select></div>
        <div class="col"><label class="small muted">Quantidade</label><input id="m_qtd" type="number" min="0" value="1" /></div>
      </div>
      <div class="form-row">
        <div class="col"><label class="small muted">Custo unit (R$)</label><input id="m_custo" type="number" min="0" step="0.01" /></div>
        <div class="col"><label class="small muted">Pre√ßo venda (R$)</label><input id="m_preco" type="number" min="0" step="0.01" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        ${isEdit ? `<button type="button" class="btn ghost" id="deleteProduct">Remover</button>` : ''}
        <button type="submit" class="btn">${isEdit ? 'Salvar altera√ß√µes' : 'Adicionar produto'}</button>
      </div>
    </form>`;

  backdrop.appendChild(modal);
  modalRoot.appendChild(backdrop);
  modalRoot.style.display = 'block';

  if(isEdit && product){
    document.getElementById('m_modelo').value = product.modelo;
    document.getElementById('m_cor').value = product.cor;
    document.getElementById('m_tamanho').value = product.tamanho;
    document.getElementById('m_qtd').value = product.qtd;
    document.getElementById('m_custo').value = product.custo;
    document.getElementById('m_preco').value = product.preco;
  }

  document.getElementById('closeModal').addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeModal(); });

  document.getElementById('productForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const novo = {
      id: isEdit ? productId : uid(),
      modelo: document.getElementById('m_modelo').value.trim(),
      cor: document.getElementById('m_cor').value.trim(),
      tamanho: document.getElementById('m_tamanho').value,
      qtd: Number(document.getElementById('m_qtd').value) || 0,
      custo: Number(document.getElementById('m_custo').value) || 0,
      preco: Number(document.getElementById('m_preco').value) || 0
    };
    if(isEdit){
      const idx = stock.findIndex(s=>s.id===productId);
      if(idx>=0) stock[idx] = novo;
    } else {
      stock.push(novo);
    }
    saveData(STORAGE_KEYS.stock, stock);
    renderAll();
    closeModal();
  });

  if(isEdit){
    document.getElementById('deleteProduct').addEventListener('click', ()=>{
      if(!confirm('Remover este produto do estoque?')) return;
      stock = stock.filter(s=>s.id !== productId);
      saveData(STORAGE_KEYS.stock, stock);
      renderAll();
      closeModal();
    });
  }

  function closeModal(){ 
    modalRoot.innerHTML = ''; 
    modalRoot.style.display = 'none'; 
  }
}

// ========== FUN√á√ÉO RENDER ALL ==========
function renderAll(){
  renderStock();
  renderSales();
  renderGastos();
  renderClientes();
  calcularResumo();
  atualizarPizza();
  atualizarRanking();
  buildProductOptionList();
  atualizarListaClientes();
}

// ========== ESTORNO ==========
function toggleEstorno(saleId){
  const idx = sales.findIndex(s=>s.id === saleId);
  if(idx < 0) return;
  const sale = sales[idx];
  
  if(!sale.estornado){
    let prodIdx = stock.findIndex(s=>s.id === sale.productId);
    if(prodIdx === -1){
      const parts = sale.nome.split(' ‚Äî ');
      const modelo = parts[0] || sale.nome;
      const cor = parts[1] || '';
      const tamanho = parts[2] || '';
      stock.push({ 
        id: sale.productId || uid(), 
        modelo, 
        cor, 
        tamanho, 
        custo: sale.custoUnit || (sale.custoTotal / sale.qtd || 0), 
        preco: sale.valorUnit || (sale.valorTotal / sale.qtd || 0), 
        qtd: 0 
      });
      prodIdx = stock.findIndex(s=>s.id === (sale.productId || uid()));
    }
    stock[prodIdx].qtd = Number(stock[prodIdx].qtd) + Number(sale.qtd);
    custosProdutosVendidos = Math.max(0, Number(custosProdutosVendidos) - Number(sale.custoTotal || (sale.custoUnit * sale.qtd || 0)));
    sale.estornado = true;
    saveCustosVendidos(custosProdutosVendidos);
    saveData(STORAGE_KEYS.sales, sales);
    saveData(STORAGE_KEYS.stock, stock);
    renderAll();
    alert('Venda estornada: estoque reestabelecido.');
  } else {
    const prodIdx = stock.findIndex(s=>s.id === sale.productId);
    if(prodIdx === -1 || Number(stock[prodIdx].qtd) < Number(sale.qtd)){
      return alert('N√£o √© poss√≠vel reaplicar: estoque insuficiente.');
    }
    stock[prodIdx].qtd = Number(stock[prodIdx].qtd) - Number(sale.qtd);
    if(stock[prodIdx].qtd <= 0) stock.splice(prodIdx,1);
    custosProdutosVendidos = Number(custosProdutosVendidos) + Number(sale.custoTotal || (sale.custoUnit * sale.qtd || 0));
    sale.estornado = false;
    saveCustosVendidos(custosProdutosVendidos);
    saveData(STORAGE_KEYS.sales, sales);
    saveData(STORAGE_KEYS.stock, stock);
    renderAll();
    alert('Venda reaplicada: estoque reduzido novamente.');
  }
}

// ========== VENDA R√ÅPIDA ==========
quickAddBtn?.addEventListener('click', ()=>{
  const pid = quickProduto.value;
  if(!pid) return alert('Selecione um produto.');
  const produto = stock.find(s=>s.id===pid);
  if(!produto) return alert('Produto n√£o encontrado.');
  const qtd = Number(quickQtd.value) || 1;
  if(qtd > Number(produto.qtd)) return alert('Quantidade maior que estoque dispon√≠vel.');
  const valorUnit = Number(quickValor.value);
  if(!valorUnit || valorUnit <= 0) return alert('Informe o valor da venda.');
  
  const now = new Date().toISOString();
  const valorTotal = Number(valorUnit) * Number(qtd);
  const lucro = (Number(valorUnit) - Number(produto.custo)) * Number(qtd);
  
  const nomeCliente = document.getElementById('quickCliente')?.value.trim() || 'Cliente An√¥nimo';

  let cliente = clientes.find(c => c.nome.toLowerCase() === nomeCliente.toLowerCase());
  if(!cliente){
    cliente = { id: uid(), nome: nomeCliente, telefone: '', compras: [], totalGasto: 0 };
    clientes.push(cliente);
  }
  cliente.compras.push({ date: now, produto: produto.modelo, valor: valorTotal });
  cliente.totalGasto = (cliente.totalGasto || 0) + valorTotal;
  cliente.ultimaCompra = now;
  saveClientes(clientes);
  
  const sale = { 
    id: uid(), 
    date: now, 
    nome: produto.modelo + ' ‚Äî ' + produto.cor + ' ‚Äî ' + produto.tamanho, 
    qtd, 
    valorTotal, 
    lucro, 
    productId: produto.id, 
    custoUnit: Number(produto.custo), 
    custoTotal: Number(produto.custo) * Number(qtd), 
    valorUnit, 
    estornado: false,
    cliente: nomeCliente
  };
  
  sales.push(sale);
  const idx = stock.findIndex(s=>s.id===produto.id);
  if(idx>=0){
    stock[idx].qtd = Number(stock[idx].qtd) - Number(qtd);
    if(stock[idx].qtd <= 0) stock.splice(idx,1);
  }
  custosProdutosVendidos += Number(produto.custo) * Number(qtd);
  saveCustosVendidos(custosProdutosVendidos);
  saveData(STORAGE_KEYS.sales, sales);
  saveData(STORAGE_KEYS.stock, stock);
  renderAll();
  alert(`Venda registrada: ${qtd} x ${produto.modelo} ‚Äî Total: ${moneyLabel(valorTotal)}`);
});

// ========== EXPORTA√á√ÉO E RESET ==========
function toCSV(rows, headers){
  const lines = [headers.join(',')];
  rows.forEach(r=>{ lines.push(headers.map(h=>`"${String(r[h] ?? '')}"`).join(',')); });
  return lines.join('\n');
}

function download(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = filename; 
  a.click();
  URL.revokeObjectURL(url);
}

function exportStockCSV(){ 
  if(stock.length===0) return alert('Estoque vazio.'); 
  const headers = ['id','modelo','cor','tamanho','qtd','custo','preco']; 
  const csv = toCSV(stock, headers); 
  download('estoque.csv', new Blob([csv], {type:'text/csv'})); 
}

function exportSalesCSV(){ 
  if(sales.length===0) return alert('Sem vendas.'); 
  const headers = ['id','date','nome','productId','qtd','valorUnit','valorTotal','custoTotal','lucro','estornado']; 
  const csv = toCSV(sales, headers); 
  download('vendas.csv', new Blob([csv], {type:'text/csv'})); 
}

exportStockBtnSide?.addEventListener('click', exportStockCSV);
exportSalesBtnSide?.addEventListener('click', exportSalesCSV);
document.getElementById('exportSalesBtnTop')?.addEventListener('click', exportSalesCSV);
document.getElementById('exportStockBtn')?.addEventListener('click', exportStockCSV);
document.getElementById('exportSalesBtn')?.addEventListener('click', exportSalesCSV);

document.getElementById('exportGastosBtn')?.addEventListener('click', ()=>{
  if(gastos.length === 0) return alert('Nenhum gasto para exportar.');
  const headers = ['id','date','desc','valor','formaPagamento','observacao'];
  const csv = toCSV(gastos, headers);
  download('gastos.csv', new Blob([csv], {type:'text/csv'}));
});

clearBtnSide?.addEventListener('click', ()=>{
  if(!confirm('Resetar vendas, gastos e custos vendidos? Isso N√ÉO ir√° deletar o estoque atual.')) return;
  sales = []; 
  gastos = []; 
  custosProdutosVendidos = 0;
  saveData(STORAGE_KEYS.sales, sales);
  saveGastos(gastos);
  saveCustosVendidos(custosProdutosVendidos);
  renderAll();
  alert('Vendas e gastos resetados (estoque mantido).');
});

// ========== FILTROS E BUSCA ==========
globalSearch?.addEventListener('input', (e)=>{
  const q = (e.target.value||'').toLowerCase();
  if(pageEstoque.style.display !== 'none') filterStock.value = q;
  if(pageVendas.style.display !== 'none') filterSales.value = q;
  renderAll();
});

filterStock?.addEventListener('input', renderStock);
filterTamanho?.addEventListener('change', renderStock);
filterSales?.addEventListener('input', renderSales);
filterEstorno?.addEventListener('change', renderSales);
document.getElementById('filterGastos')?.addEventListener('input', renderGastos);
document.getElementById('filterFormaPag')?.addEventListener('change', renderGastos);
document.getElementById('filterClientes')?.addEventListener('input', renderClientes);

// ========== BOT√ïES DE NOVO ==========
newProductBtn?.addEventListener('click', ()=> openProductModal());
newProductBtn2?.addEventListener('click', ()=> openProductModal());
document.getElementById('newClientBtn')?.addEventListener('click', () => openClienteModal());

// ========== NORMALIZA√á√ÉO E INICIALIZA√á√ÉO ==========
function normalizeSales(){
  let changed = false;
  sales = sales.map(s=>{
    if(!s.id) s.id = uid(), changed = true;
    if(!('estornado' in s)) s.estornado = false, changed = true;
    if(!('productId' in s)) s.productId = s.productId || null;
    if(!('custoTotal' in s)) s.custoTotal = s.custoTotal || (s.custoUnit ? s.custoUnit * s.qtd : 0);
    if(!('valorUnit' in s)) s.valorUnit = s.valorUnit || (s.qtd ? s.valorTotal / s.qtd : 0);
    return s;
  });
  if(changed) saveData(STORAGE_KEYS.sales, sales);
}

normalizeSales();
if(appRoot.style.display !== 'grid') loginPage.style.display = 'flex';
window.renderAll = renderAll;
if(appRoot.style.display === 'grid'){ renderAll(); }
// ========== AN√ÅLISES AVAN√áADAS ==========
let grafVendasPeriodo = null;
let grafPecasEstoque = null;
let grafInvestido = null;
let grafLucroBruto = null;
let grafLucroLiquido = null;
let periodoAtual = 'mes';

function renderAnalises(){
  renderGrafVendasPeriodo();
  renderGrafIndicadores();
}

function renderGrafVendasPeriodo(){
  const ctx = document.getElementById('grafVendasPeriodo');
  if(!ctx) return;
  
  const vendasAtivas = sales.filter(s => !s.estornado);
  const dados = calcularVendasPorPeriodo(vendasAtivas, periodoAtual);
  
  if(grafVendasPeriodo) grafVendasPeriodo.destroy();
  
  grafVendasPeriodo = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dados.labels,
      datasets: [{
        label: 'Faturamento (R$)',
        data: dados.faturamento,
        backgroundColor: 'rgba(74, 222, 128, 0.8)',
        borderColor: 'rgba(74, 222, 128, 1)',
        borderWidth: 2
      }, {
        label: 'Lucro L√≠quido (R$)',
        data: dados.lucro,
        backgroundColor: 'rgba(212, 175, 55, 0.8)',
        borderColor: 'rgba(212, 175, 55, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#e6eef6' } },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': R$ ' + moneyFmt(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { 
            color: '#a8a4b8',
            callback: function(value) {
              return 'R$ ' + moneyFmt(value);
            }
          },
          grid: { color: 'rgba(212,175,55,0.1)' }
        },
        x: { 
          ticks: { color: '#a8a4b8' },
          grid: { color: 'rgba(212,175,55,0.1)' }
        }
      }
    }
  });
}

function calcularVendasPorPeriodo(vendas, periodo){
  const agora = new Date();
  const labels = [];
  const faturamento = [];
  const lucro = [];
  
  if(periodo === 'mes'){
    for(let i = 5; i >= 0; i--){
      const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
      const mesNome = data.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
      labels.push(mesNome);
      
      const vendasMes = vendas.filter(v => {
        const dataVenda = new Date(v.date);
        return dataVenda.getMonth() === data.getMonth() && 
               dataVenda.getFullYear() === data.getFullYear();
      });
      
      const fat = vendasMes.reduce((a, b) => a + Number(b.valorTotal), 0);
      const luc = vendasMes.reduce((a, b) => a + Number(b.lucro), 0);
      const totalGastosMes = gastos.filter(g => {
        const dataGasto = new Date(g.date);
        return dataGasto.getMonth() === data.getMonth() && 
               dataGasto.getFullYear() === data.getFullYear();
      }).reduce((a, b) => a + Number(b.valor), 0);
      
      faturamento.push(fat);
      lucro.push(luc - totalGastosMes);
    }
  } else if(periodo === 'trimestre'){
    for(let i = 3; i >= 0; i--){
      const trimestre = Math.floor(agora.getMonth() / 3) - i;
      const ano = agora.getFullYear() + Math.floor(trimestre / 4);
      const trimestreAjustado = ((trimestre % 4) + 4) % 4;
      
      labels.push(`T${trimestreAjustado + 1}/${ano.toString().slice(-2)}`);
      
      const vendasTrimestre = vendas.filter(v => {
        const dataVenda = new Date(v.date);
        const trimestreVenda = Math.floor(dataVenda.getMonth() / 3);
        return trimestreVenda === trimestreAjustado && dataVenda.getFullYear() === ano;
      });
      
      const fat = vendasTrimestre.reduce((a, b) => a + Number(b.valorTotal), 0);
      const luc = vendasTrimestre.reduce((a, b) => a + Number(b.lucro), 0);
      const totalGastosTri = gastos.filter(g => {
        const dataGasto = new Date(g.date);
        const trimestreGasto = Math.floor(dataGasto.getMonth() / 3);
        return trimestreGasto === trimestreAjustado && dataGasto.getFullYear() === ano;
      }).reduce((a, b) => a + Number(b.valor), 0);
      
      faturamento.push(fat);
      lucro.push(luc - totalGastosTri);
    }
  } else if(periodo === 'semestre'){
    for(let i = 3; i >= 0; i--){
      const semestre = Math.floor(agora.getMonth() / 6) - i;
      const ano = agora.getFullYear() + Math.floor(semestre / 2);
      const semestreAjustado = ((semestre % 2) + 2) % 2;
      
      labels.push(`S${semestreAjustado + 1}/${ano.toString().slice(-2)}`);
      
      const vendasSemestre = vendas.filter(v => {
        const dataVenda = new Date(v.date);
        const semestreVenda = Math.floor(dataVenda.getMonth() / 6);
        return semestreVenda === semestreAjustado && dataVenda.getFullYear() === ano;
      });
      
      const fat = vendasSemestre.reduce((a, b) => a + Number(b.valorTotal), 0);
      const luc = vendasSemestre.reduce((a, b) => a + Number(b.lucro), 0);
      const totalGastosSem = gastos.filter(g => {
        const dataGasto = new Date(g.date);
        const semestreGasto = Math.floor(dataGasto.getMonth() / 6);
        return semestreGasto === semestreAjustado && dataGasto.getFullYear() === ano;
      }).reduce((a, b) => a + Number(b.valor), 0);
      
      faturamento.push(fat);
      lucro.push(luc - totalGastosSem);
    }
  }
  
  return { labels, faturamento, lucro };
}

function renderGrafIndicadores(){
  const totalPecas = stock.reduce((a,b)=>a + Number(b.qtd), 0);
  const totalInvestido = stock.reduce((a,b)=>a + (Number(b.custo) * Number(b.qtd)), 0);
  const lucroBruto = sales.filter(s=>!s.estornado).reduce((a,b)=>a + Number(b.valorTotal), 0);
  const totalGastos = gastos.reduce((a,b)=>a + Number(b.valor), 0);
  const lucroLiquido = lucroBruto - custosProdutosVendidos - totalGastos;
  
  document.getElementById('analise_pecas').textContent = totalPecas;
  document.getElementById('analise_investido').textContent = moneyLabel(totalInvestido);
  document.getElementById('analise_bruto').textContent = moneyLabel(lucroBruto);
  document.getElementById('analise_liquido').textContent = moneyLabel(lucroLiquido);
  
  // Gr√°fico de Pe√ßas em Estoque por Categoria
  const categorias = {};
  stock.forEach(item => {
    const cat = item.modelo || 'Outros';
    categorias[cat] = (categorias[cat] || 0) + Number(item.qtd);
  });
  
  if(grafPecasEstoque) grafPecasEstoque.destroy();
  const ctxPecas = document.getElementById('grafPecasEstoque');
  grafPecasEstoque = new Chart(ctxPecas, {
    type: 'doughnut',
    data: {
      labels: Object.keys(categorias),
      datasets: [{
        data: Object.values(categorias),
        backgroundColor: ['#4ade80', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6', '#ec4899']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#e6eef6', font: { size: 10 } } } }
    }
  });
  
  // Gr√°fico de Investido ao Longo do Tempo
  const mesesInvestimento = [];
  const valoresInvestimento = [];
  for(let i = 5; i >= 0; i--){
    const data = new Date();
    data.setMonth(data.getMonth() - i);
    mesesInvestimento.push(data.toLocaleDateString('pt-BR', { month: 'short' }));
    valoresInvestimento.push(totalInvestido / 6 * (6 - i)); // Simula√ß√£o linear
  }
  
  if(grafInvestido) grafInvestido.destroy();
  const ctxInv = document.getElementById('grafInvestido');
  grafInvestido = new Chart(ctxInv, {
    type: 'line',
    data: {
      labels: mesesInvestimento,
      datasets: [{
        label: 'Investimento',
        data: valoresInvestimento,
        borderColor: '#d4af37',
        backgroundColor: 'rgba(212, 175, 55, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { color: '#a8a4b8', font: { size: 10 } }, grid: { color: 'rgba(212,175,55,0.1)' } },
        x: { ticks: { color: '#a8a4b8', font: { size: 10 } }, grid: { display: false } }
      }
    }
  });
  
  // Gr√°fico de Lucro Bruto Mensal
  const vendasPorMes = {};
  sales.filter(s=>!s.estornado).forEach(s => {
    const mes = new Date(s.date).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
    vendasPorMes[mes] = (vendasPorMes[mes] || 0) + Number(s.valorTotal);
  });
  
  if(grafLucroBruto) grafLucroBruto.destroy();
  const ctxBruto = document.getElementById('grafLucroBruto');
  grafLucroBruto = new Chart(ctxBruto, {
    type: 'bar',
    data: {
      labels: Object.keys(vendasPorMes).slice(-6),
      datasets: [{
        label: 'Lucro Bruto',
        data: Object.values(vendasPorMes).slice(-6),
        backgroundColor: '#4ade80'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { color: '#a8a4b8', font: { size: 10 } }, grid: { color: 'rgba(212,175,55,0.1)' } },
        x: { ticks: { color: '#a8a4b8', font: { size: 10 } }, grid: { display: false } }
      }
    }
  });
  
  // Gr√°fico de Lucro L√≠quido
  const lucrosPorMes = {};
  sales.filter(s=>!s.estornado).forEach(s => {
    const mes = new Date(s.date).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
    lucrosPorMes[mes] = (lucrosPorMes[mes] || 0) + Number(s.lucro);
  });
  
  if(grafLucroLiquido) grafLucroLiquido.destroy();
  const ctxLiq = document.getElementById('grafLucroLiquido');
  grafLucroLiquido = new Chart(ctxLiq, {
    type: 'line',
    data: {
      labels: Object.keys(lucrosPorMes).slice(-6),
      datasets: [{
        label: 'Lucro L√≠quido',
        data: Object.values(lucrosPorMes).slice(-6),
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { color: '#a8a4b8', font: { size: 10 } }, grid: { color: 'rgba(212,175,55,0.1)' } },
        x: { ticks: { color: '#a8a4b8', font: { size: 10 } }, grid: { display: false } }
      }
    }
  });
}

// Event listeners para os bot√µes de per√≠odo
document.querySelectorAll('[data-periodo]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-periodo]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    periodoAtual = btn.dataset.periodo;
    renderGrafVendasPeriodo();
  });
});

// ========== AN√ÅLISE DE CUSTOS ==========
let grafCustosDistribuicao = null;

function renderCustos(){
  renderGrafCustosDistribuicao();
  renderListasCustos();
  renderTabelaCustos();
}

function renderGrafCustosDistribuicao(){
  const ctx = document.getElementById('grafCustosDistribuicao');
  if(!ctx) return;
  
  // Agrupar gastos por descri√ß√£o
  const gastosPorCategoria = {};
  gastos.forEach(g => {
    const cat = g.desc || 'Outros';
    gastosPorCategoria[cat] = (gastosPorCategoria[cat] || 0) + Number(g.valor);
  });
  
  // Ordenar do maior para o menor
  const sorted = Object.entries(gastosPorCategoria)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10); // Mostrar apenas os 10 maiores
  
  if(grafCustosDistribuicao) grafCustosDistribuicao.destroy();
  
  if(sorted.length === 0) {
    // Se n√£o houver gastos, limpar o canvas
    return;
  }
  
  grafCustosDistribuicao = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(item => item[0]),
      datasets: [{
        label: 'Valor Total (R$)',
        data: sorted.map(item => item[1]),
        backgroundColor: 'rgba(239, 68, 68, 0.8)',
        borderColor: 'rgba(239, 68, 68, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Top 10 Categorias de Gastos',
          color: '#d4af37',
          font: { size: 14, weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = sorted.reduce((a, b) => a + b[1], 0);
              const percent = ((context.parsed.x / total) * 100).toFixed(1);
              return `R$ ${moneyFmt(context.parsed.x)} (${percent}%)`;
            }
          }
        }
      },
      scales: {
        x: { 
          beginAtZero: true,
          ticks: { 
            color: '#a8a4b8',
            callback: function(value) {
              return 'R$ ' + moneyFmt(value);
            }
          },
          grid: { color: 'rgba(212,175,55,0.1)' }
        },
        y: { 
          ticks: { color: '#a8a4b8', font: { size: 11 } },
          grid: { display: false }
        }
      }
    }
  });
}

function renderListasCustos(){
  const sorted = gastos.slice().sort((a, b) => Number(b.valor) - Number(a.valor));
  
  const listaMaiores = document.getElementById('listaMaioresCustos');
  const listaMenores = document.getElementById('listaMenoresCustos');
  
  if(!listaMaiores || !listaMenores) return;
  
  // Maiores Gastos
  listaMaiores.innerHTML = '';
  if(sorted.length === 0) {
    listaMaiores.innerHTML = '<div class="small muted">Nenhum gasto registrado</div>';
  } else {
    const maiores = sorted.slice(0, 5);
    maiores.forEach((g, index) => {
      const div = document.createElement('div');
      div.className = 'pill';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="flex:1">
            <div style="font-weight:600;display:flex;align-items:center;gap:8px">
              <span style="background:var(--danger);color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px">${index + 1}</span>
              ${g.desc}
            </div>
            <div class="small muted">${new Date(g.date).toLocaleDateString('pt-BR')} ‚Ä¢ ${g.formaPagamento || 'N/A'}</div>
          </div>
          <div style="font-weight:800;font-size:18px;color:var(--danger)">${moneyLabel(g.valor)}</div>
        </div>
      `;
      listaMaiores.appendChild(div);
    });
  }
  
  // Menores Gastos
  listaMenores.innerHTML = '';
  if(sorted.length === 0) {
    listaMenores.innerHTML = '<div class="small muted">Nenhum gasto registrado</div>';
  } else {
    const menores = sorted.slice(-5).reverse();
    menores.forEach((g, index) => {
      const div = document.createElement('div');
      div.className = 'pill';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="flex:1">
            <div style="font-weight:600;display:flex;align-items:center;gap:8px">
              <span style="background:var(--success);color:#1a1625;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px">${index + 1}</span>
              ${g.desc}
            </div>
            <div class="small muted">${new Date(g.date).toLocaleDateString('pt-BR')} ‚Ä¢ ${g.formaPagamento || 'N/A'}</div>
          </div>
          <div style="font-weight:800;font-size:18px;color:var(--success)">${moneyLabel(g.valor)}</div>
        </div>
      `;
      listaMenores.appendChild(div);
    });
  }
}

function renderTabelaCustos(){
  const tbody = document.getElementById('tabelaCustos');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  const sorted = gastos.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if(sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="muted">Nenhum gasto registrado</td></tr>';
    return;
  }
  
  sorted.forEach(g => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${g.desc}</td>
      <td><strong>${moneyLabel(g.valor)}</strong></td>
      <td>${new Date(g.date).toLocaleDateString('pt-BR')}</td>
      <td>${g.formaPagamento || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderTabelaCustos(){
  const tbody = document.getElementById('tabelaCustos');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  const sorted = gastos.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
  
  sorted.forEach(g => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${g.desc}</td>
      <td><strong>${moneyLabel(g.valor)}</strong></td>
      <td>${new Date(g.date).toLocaleDateString('pt-BR')}</td>
      <td>${g.formaPagamento || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}
window.addEventListener('beforeunload', ()=>{
  saveData(STORAGE_KEYS.stock, stock);
  saveData(STORAGE_KEYS.sales, sales);
  saveGastos(gastos);
  saveCustosVendidos(custosProdutosVendidos);
});

  </script>
</body>
</html>
